import javax.swing.*;
import java.awt.*;
import java.awt.event.*;
import java.awt.font.FontRenderContext;
import java.awt.geom.AffineTransform;

public class PongGame extends JPanel implements KeyListener, ActionListener {
    private int paddle1Y = 150, paddle2Y = 150, paddle3X = 225;
    private int ballX = 250, ballY = 250;
    private int ballDirX = -2, ballDirY = 2;
    private final int PADDLE_WIDTH = 10, PADDLE_HEIGHT = 50;
    private final int BALL_SIZE = 10;
    private int score1 = 0, score2 = 0, score3 = 0;
    private Timer timer;
    private int playerCount = 3;

    public PongGame() {
        setPreferredSize(new Dimension(500, 500));
        setBackground(Color.BLACK);
        setFocusable(true);
        addKeyListener(this);
        timer = new Timer(5, this);
        timer.start();
        createMenu();
    }

    private void createMenu() {
        JMenuBar menuBar = new JMenuBar();
        JMenu menu = new JMenu("Options");
        JMenuItem twoPlayers = new JMenuItem("2 Players");
        JMenuItem threePlayers = new JMenuItem("3 Players");

        twoPlayers.addActionListener(e -> setPlayerCount(2));
        threePlayers.addActionListener(e -> setPlayerCount(3));

        menu.add(twoPlayers);
        menu.add(threePlayers);
        menuBar.add(menu);

        JFrame frame = new JFrame("Pong Game");
        frame.setJMenuBar(menuBar);
        frame.add(this);
        frame.pack();
        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        frame.setVisible(true);
    }

    private void setPlayerCount(int count) {
        playerCount = count;
        resetGame();
    }

    private void resetGame() {
        paddle1Y = 150;
        paddle2Y = 150;
        paddle3X = 225;
        ballX = 250;
        ballY = 250;
        score1 = 0;
        score2 = 0;
        score3 = 0;
        ballDirX = -2;
        ballDirY = 2;
        repaint();
    }

    public void paintComponent(Graphics g) {
        super.paintComponent(g);

        // Draw middle line
        g.setColor(Color.WHITE);
        g.drawLine(250, 0, 250, 500);

        // Draw paddles
        g.fillRect(20, paddle1Y, PADDLE_WIDTH, PADDLE_HEIGHT);
        g.fillRect(470, paddle2Y, PADDLE_WIDTH, PADDLE_HEIGHT);
        if (playerCount == 3) {
            g.fillRect(paddle3X, 470, PADDLE_HEIGHT, PADDLE_WIDTH);
        }

        // Draw ball
        g.fillOval(ballX, ballY, BALL_SIZE, BALL_SIZE);

        // Draw scores
        drawScore(g, score1, 100, 50);
        drawScore(g, score2, 400, 50);
        if (playerCount == 3) {
            drawScore(g, score3, 250, 450);
        }
    }

    private void drawScore(Graphics g, int score, int x, int y) {
        try {
            Font pixelFont = Font.createFont(Font.TRUETYPE_FONT, getClass().getResourceAsStream("/fonts/PressStart2P.ttf")).deriveFont(24f);
            g.setFont(pixelFont);
        } catch (Exception e) {
            e.printStackTrace();
            g.setFont(new Font("Monospaced", Font.PLAIN, 24));
        }
        g.drawString(String.valueOf(score), x, y);
    }

    public void actionPerformed(ActionEvent e) {
        ballX += ballDirX;
        ballY += ballDirY;

        if (ballY <= 0 || ballY >= getHeight() - BALL_SIZE) {
            ballDirY = -ballDirY;
        }

        if (ballX <= 30 && ballY >= paddle1Y && ballY <= paddle1Y + PADDLE_HEIGHT) {
            ballDirX = -ballDirX;
        }

        if (ballX >= 460 && ballY >= paddle2Y && ballY <= paddle2Y + PADDLE_HEIGHT) {
            ballDirX = -ballDirX;
        }

        if (playerCount == 3 && ballY >= 460 && ballX >= paddle3X && ballX <= paddle3X + PADDLE_HEIGHT) {
            ballDirY = -ballDirY;
        }

        if (ballX < 0) {
            score2++;
            resetBall();
        } else if (ballX > getWidth()) {
            score1++;
            resetBall();
        } else if (playerCount == 3 && ballY > getHeight()) {
            score3++;
            resetBall();
        }

        repaint();
    }

    private void resetBall() {
        ballX = 250;
        ballY = 250;
        ballDirX = -ballDirX;
    }

    public void keyPressed(KeyEvent e) {
        int key = e.getKeyCode();
        if (key == KeyEvent.VK_W && paddle1Y > 0) {
            paddle1Y -= 10;
        }
        if (key == KeyEvent.VK_S && paddle1Y < getHeight() - PADDLE_HEIGHT) {
            paddle1Y += 10;
        }
        if (key == KeyEvent.VK_UP && paddle2Y > 0) {
            paddle2Y -= 10;
        }
        if (key == KeyEvent.VK_DOWN && paddle2Y < getHeight() - PADDLE_HEIGHT) {
            paddle2Y += 10;
        }
        if (playerCount == 3) {
            if (key == KeyEvent.VK_A && paddle3X > 0) {
                paddle3X -= 10;
            }
            if (key == KeyEvent.VK_D && paddle3X < getWidth() - PADDLE_HEIGHT) {
                paddle3X += 10;
            }
        }
    }

    public void keyReleased(KeyEvent e) {}
    public void keyTyped(KeyEvent e) {}

    public static void main(String[] args) {
        SwingUtilities.invokeLater(PongGame::new);
    }
}
